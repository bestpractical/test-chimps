<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>Smoke Reports</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <style type="text/css">
    body {
      background-color: white;
      margin:           0;

      font-family: sans-serif;
      line-height: 1.3em;
      font-size:   95%;
    }

    h1, h2 {
      background-color: #313052;
      color:            white;
      padding:          10px;
    }

    th       { text-align: left; }
    .category       { padding-top:  30px; border-bottom: 2px solid #313052; }
    .subcategory    { padding-top:  10px; border-bottom: 1px solid #313052; }
    .report_summary { padding-left: 40px; }
    .report_details { padding-left: 80px; padding-bottom: 10px; }

    p, dl, pre, table { margin:      15px; }
    dt    { font-weight: bold; }
    dd+dt { margin-top:  1em;  }
    .leftsep  { padding-left: 10px;  }
    .num      { text-align:   right; }

    .details  { display: none; }
    .expander { color: blue; cursor: pointer; }  /* hack? */

    .tests_ok       { color: #050; }
    .tests_failed   { color: #500; }
    .tests_todo     { color: #030; }
    .tests_skipped  { color: #555; }
    .tests_unexpect { color: #550; }
  </style>

  <script type="text/javascript">//<![CDATA[[
    function toggle_visibility (id) {
      var elem     = document.getElementById("details_"  + id),
          expander = document.getElementById("expander_" + id);
      if(elem.className == "details") {
	elem.className = "";  /* hack? */
	expander.innerHTML = "&laquo;";
      } else {
	elem.className = "details";
	expander.innerHTML = "&raquo;";
      }
    }
  //]]></script>
</head>

<body>
  <h1>Smoke Reports</h1>

  <p>
    Note that old smoke reports may be automatically deleted, so you may not want
    to link directly to a smoke.
  </p>

  <p>
    Timezone is UTC
  </p>
 
  <table>
% foreach my $category (keys %categories) {
      <tr><th colspan="11" class="category"><% $category %></th></tr>
% foreach my $subcategory (keys %{$categories{$category}}) {
        <tr><th colspan="11" class="subcategory"><% $subcategory %></th></tr>
% foreach my $report (@{$categories{$category}->{$subcategory}}) {
% my $id = 5;
% my $data = $report->extra_data;
% my $model = Test::TAP::Model::Visual->new_with_struct($report->model_structure);
          <tr>
            <td class="report_summary"><% $data->{project} %></td>
            <td>
              r<% $data->{revision} %>
            </td>
            <td class="leftsep"><% $data->{timestamp} %></td>
            <td class="leftsep num"><% $data->{duration} %></td>
            <td class="leftsep num"><% $model->total_ratio %>>&nbsp;%&nbsp;ok</td>
	    <td class="leftsep num tests_total"><span title="<% $model->total_seen %> total"><% $model->total_seen %></span>:</td>
	    <td class="num tests_ok"><span title="<% $model->total_ok %> ok"><% $model->total_ok %></span>,</td>
	    <td class="num tests_failed"><span title="<% $model->total_failed %> failed"><% $model->total_failed %></span>,</td>
	    <td class="num tests_todo"><span title="<% $model->total_todo %> todo"><% $model->total_todo %></span>,</td>
	    <td class="num tests_skipped"><span title="<% $model->total_skipped %> skipped"><% $model->total_skipped %></span>,</td>
	    <td class="num tests_unexpect"><span title="<% $model->total_unexpectedly_succeeded %> unexpectedly succeeded"><% $model->total_unexpectedly_succeeded %></span></td>
	    <td><span title="Details" class="expander" onclick="toggle_visibility('<% $id %>')" id="expander_<% $id %>">&raquo;</span></td>
	    <td><a style="text-decoration: none" href="<tmpl_var name=link>" title="Full smoke report">&raquo;</a></td>
          </tr>
          <tr class="details" id="details_<% $id %>">
            <td colspan="11" class="report_details">
                <span class="tests_total"><% $model->total_seen %> test cases</span>:<br />
		<span class="tests_ok"><% $model->total_ok %> ok</span>,
		<span class="tests_failed"><% $model->total_failed %> failed</span>,
		<span class="tests_todo"><% $model->total_todo %> todo</span>,<br />
                <span class="tests_skipped"><% $model->total_skipped %> skipped</span> and
		<span class="tests_unexpect"><% $model->total_unexpectedly_succeeded %> unexpectedly succeeded</span>
              <br />
              <a href="<tmpl_var name=link>" title="Full smoke report">View full smoke report</a>
            </td>
          </tr>
% }
% }
% }
  </table>
</body>
</html>

<%args>
@reports
</%args>

<%init>
my %categories;
foreach my $report (@reports) {
  my $data = $report->extra_data;
  $categories{$data->{category}}->{$data->{subcategory}} = $report;
}
</%init>
